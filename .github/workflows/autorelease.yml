name: Auto-release on main

on:
  pull_request:
    branches: [ main ]
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # get full history so we can diff

      - name: Extract version from PR title
        id: get_version
        run: |
          msg='${{ github.event.pull_request.title }}'
          if [[ "$msg" =~ [Uu]pdate.*[Tt]o[[:space:]]+([0-9]+\.[0-9]+(\.[0-9]+)?) ]]; then
            ver="${BASH_REMATCH[1]}"
            echo "version=$ver" >> $GITHUB_OUTPUT
          else
            echo "PR title does not match pattern - skipping release."
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Skip when no version
        if: ${{ steps.get_version.outputs.version == '' }}
        run: echo "Nothing to do."

      - name: Create Git tag
        if: ${{ steps.get_version.outputs.version != '' }}
        run: |
          ver="v${{ steps.get_version.outputs.version }}"
          git tag -f "$ver" "$GITHUB_SHA"
          git push -f origin "refs/tags/$ver"

      - name: Create GitHub release
        if: ${{ steps.get_version.outputs.version != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ver="v${{ steps.get_version.outputs.version }}"

          if gh release view "$ver" &>/dev/null; then
            gh release delete "$ver" --yes
          fi

          gh release create "$ver" \
            --title "$ver" \
            --target "$GITHUB_SHA"
